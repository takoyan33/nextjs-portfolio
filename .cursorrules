# Next.js Portfolio プロジェクト - Cursor Rules

## 基本方針

- 日本語で応答すること
- 必要に応じて、ユーザに質問を行い、要求を明確にすること
- 作業後、作業内容とユーザが次に取れる行動を説明すること
- 作業項目が多い場合は、段階に区切り、git commit を行いながら進めること
  - semantic commit を使用する
- コマンドの出力が確認できない場合、適切なツールを使用して確認すること
- yarn コマンドで基本実施する
- マージ、リバートをする際は、許可を得てから行うこと
- **yarn dev:mockでローカル環境を立ち上げる**

---

## コーディング規約

- 変数名や関数名は意味のある名前を使ってください
- コメントは簡潔かつ具体的に書いてください
- JSDOC コメントを使用して、関数の引数や戻り値の説明を追加してください
- マジックナンバーは避け、定数として定義してください
- コードの可読性を重視してください
- コンポーネント名・型名はPascalCase、関数・変数名はcamelCaseを使用する
- インデントは2スペース、タブは使用しない
- 波括弧 {} はJSX/JSの標準スタイル（改行せず同じ行に書く）
- 短い説明には//、詳細な説明や複数行には/* ... */を使う

---

## React コンポーネント作成規則

適用対象: `components/**/*.tsx`, `app/**/*.tsx`

- クラスコンポーネントではなく、**関数コンポーネントとフックを使ってください**
- props は TypeScript の `interface` または `type` で定義してください
- スタイリングには **SCSS/CSS Module** を使用してください（ファイル名: `ComponentName.module.scss`）
- JSX 内ではロジックを複雑にしすぎず、必要であれば関数に切り出してください
- コンポーネントは単一責任の原則に従い、役割を明確にする
- 状態管理が必要な場合は Zustandを使用する
- 1ファイル1コンポーネントを基本とし、関数コンポーネントを推奨
- 1つのコンポーネント/関数は1つの責務に絞る。50行以内を目安に分割を検討
- 関数名・ハンドラ名は動詞から始める（例: handleClick, fetchData）
- PropsやStateは必要最小限にし、型定義（TypeScript）を明確にする

---

## スタイリング

- SCSS/CSS Moduleを使用（`ComponentName.module.scss`）
- グローバルCSSは `styles/globals.scss` に限定
- 共通変数は `styles/common/_variables.scss` を使用

---

## テストガイドライン

適用対象: `**/*.test.@(ts|tsx|js|jsx)`, `**/tests/**/*`

### 単体テストについて

- 単体テストは `@testing-library/react` を使い、テストランナーは `vitest` を使用してください
- 外部モジュールのモック化には `vi.mock` を使ってください
- **テストコードは `__tests__/unit` ディレクトリ以下に配置してください（例: `__tests__/unit/Button.test.tsx`）**
- 実装詳細ではなく、**ユーザーの操作や画面上の振る舞いをテスト**してください
- `describe` / `it` ブロックの説明は、何をテストしているか明確に記述してください
- import は**相対パス**で指定してください
  - 例: `import { ContactForm } from "../../app/contact/_containers/contact-form"`
- `.toBeInTheDocument()` ではなく、`.toBeVisible()` を使ってください
- `debug()` を使って、テスト実行時にDOMツリーを出力してください
- `const router = useRouter()` がある場合はモックにしてください
- **正常系テストは1-2個、異常系テストも1個は作成してください**
- **テスト名は日本語でお願いします**

### ページテスト（統合テスト）について

- ページでの統合テストは `@testing-library/react` を使い、テストランナーは `vitest` を使用してください
- 外部モジュールのモック化には `vi.mock` を使ってください
- **テストコードは `__tests__/integration` ディレクトリ以下に配置してください（例: `__tests__/integration/page.test.tsx`）**
- 実装詳細ではなく、**ユーザーの操作や画面上の振る舞いをテスト**してください
- `describe` / `it` ブロックの説明は、何をテストしているか明確に記述してください
- import は**相対パス**で指定してください
- `.toBeInTheDocument()` ではなく、`.toBeVisible()` を使ってください
- `debug()` を使って、テスト実行時にDOMツリーを出力してください
- `const router = useRouter()` がある場合はモックにしてください

### E2Eテストについて

- E2E テストは **Playwright** を使用してください
- E2E テストファイルは `__tests__/e2e/` ディレクトリに配置してください
- **ユーザーの操作フローや画面遷移を中心にテスト**してください

### テスト作成時のポイント

1. **AAA パターン**に従う
   - Arrange（準備）: テストに必要なデータやモックを準備
   - Act（実行）: ユーザー操作や関数実行
   - Assert（検証）: 期待する結果を検証

2. **テストのカバレッジ**
   - 正常系: 主要な機能が期待通りに動作することを確認
   - 異常系: エラーハンドリングが正しく機能することを確認
   - エッジケース: 境界値や特殊な条件での動作を確認

3. **モック化の指針**
   - 外部APIやDBアクセスは必ずモック化
   - Next.jsのルーター (`useRouter`) はモック化
   - 日付や乱数など非決定的な値はモック化

---

## Storybook作成ガイドライン

適用対象: `stories/**/*.stories.@(ts|tsx|js|jsx)`

### 基本ルール

- Storybook は **CSF3 形式**で記述すること
- `Meta` と `StoryObj` を使用する
- TypeScript の型安全を維持するため、`Meta<typeof Component>` を定義する
- 各ストーリーには `args` を定義し、`Controls` による操作が可能であること
- `argTypes`には、引数があれば型情報を追加する
- 相互作用テストが必要な場合は `play` 関数を使用する
- Story ファイルの拡張子は `.stories.tsx` とする
- **正常パターンと引数で値が変わる場合（真偽値がある場合）は、複数のストーリーを作成してください**
- **異常パターンのストーリーも1つは作成してください**

### Storybook 作成手順

1. コンポーネントのインポート
```tsx
import type { Meta, StoryObj } from "@storybook/nextjs-vite"
import { ComponentName } from "./ComponentName"
```

2. Meta の定義
```tsx
const meta: Meta<typeof ComponentName> = {
  title: "UI/ComponentName",
  component: ComponentName,
  parameters: {
    layout: "centered",
  },
  tags: ["autodocs"],
}

export default meta
```

3. Story の型エイリアス
```tsx
type Story = StoryObj<typeof ComponentName>
```

4. 基本ストーリーの作成
```tsx
export const Default: Story = {
  args: {
    prop1: "value",
    prop2: true,
  },
}
```

### 注意事項

- コンポーネントのすべてのバリエーションをカバーするストーリーを作成する
- インタラクティブなコンポーネントには `play` 関数でテストを追加する
- `args` は Controls で変更可能にし、ドキュメント性を高める

---

## フロントエンド設計書作成ガイド

### 基本方針

- 日本語で出力すること
- 作成対象は **フロントエンドの詳細設計書（Markdown形式）**
- ファイルは `docs/frontend/` ディレクトリに格納すること
- コード例・UI仕様・イベントフローなどを含め、**開発者が実装可能なレベル**まで具体的に記載すること
- 図や処理の流れは **Mermaid 記法**で表現すること

### 詳細設計書の構成

各ページの設計書は以下のセクション構成で作成してください：

1. **ページ概要**
   - ページの目的・機能概要
   - 対象ユーザー・利用シナリオ
   - 関連ページへの遷移

2. **UI構成**
   - 主なコンポーネント構造
   - 使用ライブラリ・UIパーツ
   - レイアウトの説明（GridやFlex構成など）

3. **データフロー**
   - Mermaid記法でフローチャートを記述

4. **状態管理・ロジック**
   - 使用ストア（例：Zustand）
   - 主なstate・getter・action の一覧
   - API通信時のローディング・エラー処理の流れ

5. **ルーティング**
   - ページのパス構成 (/portfolio/:id など)
   - ルーティングガード・条件付き遷移がある場合はその内容

6. **イベント・アクション仕様**
   - 表形式でイベント、発火条件、処理内容、結果を記載

7. **APIインターフェース**
   - 表形式でエンドポイント、メソッド、リクエスト例、レスポンス例を記載

8. **エラーハンドリング**
   - バリデーションエラー
   - API失敗時のメッセージ方針
   - 再試行処理の有無

9. **その他仕様**
   - SEO設定 / Meta情報
   - パフォーマンス考慮点（画像最適化、キャッシュなど）

### 命名規則・ドキュメント生成ルール

- コンポーネント名、変数名は**役割が明確な英単語**を使用する
- マジックナンバーは避け、`const` として定義する
- JSDoc コメントで引数・戻り値の型を明示する
- コード例を含める場合はTypeScriptで記述する

---

## エラーハンドリング

- エラーはtry-catchやError Boundaryで適切に処理し、UI上でユーザーに分かりやすく伝える
- エラーメッセージは具体的かつ意味のある内容にする
- 例外をコントロールフローとして使わない

---

## MCP Server

- MCP Serverを起動の際は、yarn dev:mockで動かす

### 利用可能なMCPサーバー

1. **next-devtools-mcp** - Next.js開発ツール（リアルタイム診断、ルート情報、エラー検出）
2. **chrome-devtools-mcp** - Chrome DevTools統合（ブラウザテスト、ビジュアル検証）
3. **context7** (`@upstash/context7-mcp`) - 最新のライブラリドキュメント提供
4. **playwright-mcp** - Playwrightブラウザ自動化

---

## コマンド

```bash
# 開発環境起動（モック環境）
yarn dev:mock

# 開発環境起動（通常）
yarn dev

# ビルド
yarn build

# 本番環境起動
yarn start

# Lint実行
yarn lint

# テスト実行
yarn test

# ウォッチモード
yarn test:watch

# カバレッジ確認
yarn test:coverage

# E2Eテスト
yarn playwright
yarn playwright:ui

# Storybook起動
yarn storybook

# Lighthouse起動
yarn unlighthouse
```

---

## ディレクトリ構成

```
.
├── app/              # Next.js App Router
│   ├── (auth)/      # 認証関連ページ
│   ├── (home)/      # ホームページ
│   ├── about/       # Aboutページ
│   ├── api/         # APIルート
│   ├── blog/        # ブログページ
│   ├── contact/     # お問い合わせページ
│   └── portfolios/  # ポートフォリオページ
├── components/       # 再利用可能なコンポーネント
│   ├── layout/     # レイアウトコンポーネント
│   ├── parts/      # パーツコンポーネント
│   └── ui/         # UIコンポーネント
├── __tests__/       # テストファイル
│   ├── unit/       # 単体テスト
│   ├── integration/# 統合テスト
│   └── e2e/        # E2Eテスト
├── hooks/           # カスタムフック
├── styles/          # スタイルファイル
│   ├── common/     # 共通スタイル
│   ├── component/  # コンポーネントスタイル
│   └── page/       # ページスタイル
├── utils/           # ユーティリティ関数
├── types/           # 型定義
├── docs/            # ドキュメント
│   └── frontend/   # フロントエンド設計書
└── stories/         # Storybookストーリー
```

